<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <title>MagnetDownloader - Browser P2P</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Download files from magnet links using browser P2P technology">
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- WebTorrent CDN -->
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    
    <style>
        :root {
            --dark-bg: linear-gradient(135deg, #232526 0%, #414345 100%);
            --light-bg: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            --dark-card: rgba(34, 49, 63, 0.95);
            --light-card: rgba(255, 255, 255, 0.95);
            --dark-text: #dde1e7;
            --light-text: #232526;
        }

        body {
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .dark-mode {
            background: var(--dark-bg);
            color: var(--dark-text);
        }

        .light-mode {
            background: var(--light-bg);
            color: var(--light-text);
        }

        .card {
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-radius: 1.2rem;
            border: none;
            transition: all 0.3s ease;
        }

        .dark-mode .card {
            background: var(--dark-card);
        }

        .light-mode .card {
            background: var(--light-card);
        }

        .toggle-btn {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 1000;
        }

        .progress {
            height: 20px;
            border-radius: 10px;
        }

        .download-info {
            display: none;
            margin-top: 1rem;
        }

        .download-info.show {
            display: block;
        }

        .file-item {
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
        }

        .dark-mode .file-item {
            background: rgba(255,255,255,0.05);
        }

        .status-badge {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-connecting {
            background: #ffc107;
            color: #000;
        }

        .status-downloading {
            background: #17a2b8;
            color: #fff;
        }

        .status-seeding {
            background: #28a745;
            color: #fff;
        }

        .status-error {
            background: #dc3545;
            color: #fff;
        }

        .peer-info {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 0.5rem;
        }

        .btn {
            border-radius: 0.8rem;
            padding: 0.8rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
    </style>
</head>
<body class="dark-mode" id="body">
    <!-- Theme Toggle -->
    <div class="toggle-btn">
        <button class="btn btn-outline-light btn-sm" onclick="toggleMode()" id="toggleBtn">
            ‚òÄÔ∏è Light
        </button>
    </div>

    <!-- Status Badge -->
    <div class="status-badge status-connecting" id="statusBadge">üîó Ready</div>

    <div class="container d-flex justify-content-center align-items-center" style="min-height: 100vh;">
        <div class="row w-100 justify-content-center">
            <div class="col-12 col-md-10 col-lg-8">
                <div class="card p-4 p-md-5">
                    <!-- Header -->
                    <div class="text-center mb-4">
                        <h1 class="display-6 fw-bold mb-2">üß≤ MagnetDownloader</h1>
                        <p class="text-muted">Browser-based P2P downloads with WebTorrent</p>
                    </div>

                    <!-- Download Form -->
                    <form id="downloadForm" class="mb-4">
                        {% csrf_token %}
                        <div class="mb-4">
                            <label for="magnet" class="form-label fw-semibold">
                                Paste your Magnet Link
                            </label>
                            <input 
                                type="text" 
                                class="form-control form-control-lg" 
                                id="magnet" 
                                name="magnet" 
                                required 
                                placeholder="magnet:?xt=urn:btih:..."
                                autocomplete="off"
                                {% if magnet_link %}value="{{ magnet_link }}"{% endif %}
                            >
                            <div class="form-text">
                                WebTorrent works best with popular torrents that have WebTorrent-compatible peers
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success btn-lg w-100" id="downloadBtn">
                            üöÄ Start Download
                        </button>
                    </form>

                    <!-- Error Display -->
                    {% if error %}
                        <div class="alert alert-danger" role="alert">
                            <strong>Error:</strong> {{ error }}
                        </div>
                    {% endif %}

                    <!-- Download Progress -->
                    <div class="download-info" id="downloadInfo">
                        <h5>Download Progress</h5>
                        
                        <!-- Progress Bar -->
                        <div class="progress mb-3">
                            <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%">0%</div>
                        </div>
                        
                        <!-- Stats -->
                        <div class="row text-center mb-3">
                            <div class="col-3">
                                <small class="text-muted d-block">Downloaded</small>
                                <strong id="downloaded">0 MB</strong>
                            </div>
                            <div class="col-3">
                                <small class="text-muted d-block">Speed</small>
                                <strong id="downloadSpeed">0 KB/s</strong>
                            </div>
                            <div class="col-3">
                                <small class="text-muted d-block">Peers</small>
                                <strong id="numPeers">0</strong>
                            </div>
                            <div class="col-3">
                                <small class="text-muted d-block">ETA</small>
                                <strong id="timeRemaining">--</strong>
                            </div>
                        </div>

                        <!-- Files List -->
                        <div id="filesList"></div>

                        <!-- Control Buttons -->
                        <div class="mt-3 text-center">
                            <button class="btn btn-warning me-2" id="pauseBtn" onclick="pauseDownload()" style="display: none;">
                                ‚è∏Ô∏è Pause
                            </button>
                            <button class="btn btn-info me-2" id="resumeBtn" onclick="resumeDownload()" style="display: none;">
                                ‚ñ∂Ô∏è Resume
                            </button>
                            <button class="btn btn-danger" id="stopBtn" onclick="stopDownload()" style="display: none;">
                                üõë Stop
                            </button>
                        </div>
                    </div>

                    <!-- Features -->
                    <div class="mt-4">
                        <h6 class="fw-bold mb-3">‚ú® WebTorrent Features:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li>‚úÖ Browser-based P2P</li>
                                    <li>‚úÖ No server required</li>
                                    <li>‚úÖ Direct downloads</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li>üîó WebRTC connections</li>
                                    <li>üì± Works on mobile</li>
                                    <li>‚ö° Real-time streaming</li>
                                </ul>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3">
                            <small>
                                <strong>Note:</strong> WebTorrent connects to both traditional BitTorrent clients and WebTorrent peers. 
                                Download success depends on peer availability and WebRTC compatibility.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let client = new WebTorrent();
        let currentTorrent = null;

        // Theme Management
        function toggleMode() {
            const body = document.getElementById('body');
            const btn = document.getElementById('toggleBtn');
            
            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                btn.classList.remove('btn-outline-light');
                btn.classList.add('btn-outline-dark');
                btn.innerHTML = 'üåô Dark';
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                btn.classList.remove('btn-outline-dark');
                btn.classList.add('btn-outline-light');
                btn.innerHTML = '‚òÄÔ∏è Light';
                localStorage.setItem('theme', 'dark');
            }
        }

        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                const body = document.getElementById('body');
                const btn = document.getElementById('toggleBtn');
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                btn.classList.remove('btn-outline-light');
                btn.classList.add('btn-outline-dark');
                btn.innerHTML = 'üåô Dark';
            }
        }

        // Form handling
        document.getElementById('downloadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const magnetLink = document.getElementById('magnet').value.trim();
            
            if (!magnetLink) {
                alert('Please enter a magnet link');
                return;
            }
            
            if (!magnetLink.startsWith('magnet:?xt=urn:btih:')) {
                alert('Please enter a valid magnet link');
                return;
            }
            
            startDownload(magnetLink);
        });

        function startDownload(magnetLink) {
            // Clear any existing torrent
            if (currentTorrent) {
                currentTorrent.destroy();
            }

            // Show download info
            document.getElementById('downloadInfo').classList.add('show');
            updateStatus('üîó Connecting...', 'status-connecting');
            
            // Reset progress
            updateProgress(0, 0, 0, 0, 0, '--');
            
            // Start download
            currentTorrent = client.add(magnetLink);
            
            currentTorrent.on('metadata', function () {
                updateStatus('üì• Downloading...', 'status-downloading');
                console.log('Metadata received, files:', currentTorrent.files.length);
                displayFiles();
                showControlButtons();
            });
            
            currentTorrent.on('download', function (bytes) {
                const progress = Math.round(currentTorrent.progress * 100);
                const downloaded = formatBytes(currentTorrent.downloaded);
                const downloadSpeed = formatBytes(currentTorrent.downloadSpeed) + '/s';
                const numPeers = currentTorrent.numPeers;
                const uploaded = formatBytes(currentTorrent.uploaded);
                const timeRemaining = formatTime(currentTorrent.timeRemaining);
                
                updateProgress(progress, downloaded, downloadSpeed, numPeers, uploaded, timeRemaining);
            });
            
            currentTorrent.on('done', function () {
                updateStatus('üå± Seeding Complete!', 'status-seeding');
                console.log('Download complete!');
            });
            
            currentTorrent.on('error', function (err) {
                updateStatus('‚ùå Error: ' + err.message, 'status-error');
                console.error('Download error:', err);
            });
        }

        function displayFiles() {
            const filesList = document.getElementById('filesList');
            filesList.innerHTML = '<h6 class="mt-3 mb-2">Files:</h6>';
            
            currentTorrent.files.forEach(function(file, index) {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'file-item';
                fileDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${file.name}</strong>
                            <small class="text-muted d-block">${formatBytes(file.length)}</small>
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="downloadFile(${index})">
                            üì• Download
                        </button>
                    </div>
                `;
                filesList.appendChild(fileDiv);
            });
        }

        function downloadFile(index) {
            const file = currentTorrent.files[index];
            file.getBlobURL(function (err, url) {
                if (err) {
                    console.error('Error getting file URL:', err);
                    return;
                }
                
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // Clean up the blob URL
                setTimeout(() => URL.revokeObjectURL(url), 1000);
            });
        }

        function updateProgress(progress, downloaded, speed, peers, uploaded, timeRemaining) {
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressBar').textContent = progress + '%';
            document.getElementById('downloaded').textContent = downloaded;
            document.getElementById('downloadSpeed').textContent = speed;
            document.getElementById('numPeers').textContent = peers;
            document.getElementById('timeRemaining').textContent = timeRemaining;
        }

        function updateStatus(message, className) {
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = message;
            statusBadge.className = 'status-badge ' + className;
        }

        function showControlButtons() {
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'inline-block';
        }

        function pauseDownload() {
            if (currentTorrent) {
                currentTorrent.pause();
                document.getElementById('pauseBtn').style.display = 'none';
                document.getElementById('resumeBtn').style.display = 'inline-block';
                updateStatus('‚è∏Ô∏è Paused', 'status-connecting');
            }
        }

        function resumeDownload() {
            if (currentTorrent) {
                currentTorrent.resume();
                document.getElementById('resumeBtn').style.display = 'none';
                document.getElementById('pauseBtn').style.display = 'inline-block';
                updateStatus('üì• Downloading...', 'status-downloading');
            }
        }

        function stopDownload() {
            if (currentTorrent) {
                currentTorrent.destroy();
                currentTorrent = null;
                document.getElementById('downloadInfo').classList.remove('show');
                document.getElementById('pauseBtn').style.display = 'none';
                document.getElementById('resumeBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'none';
                updateStatus('üîó Ready', 'status-connecting');
            }
        }

        // Utility functions
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatTime(ms) {
            if (!ms || ms === Infinity) return '--';
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return hours + 'h ' + (minutes % 60) + 'm';
            } else if (minutes > 0) {
                return minutes + 'm ' + (seconds % 60) + 's';
            } else {
                return seconds + 's';
            }
        }

        // Auto-start if magnet link is provided
        {% if magnet_link %}
        document.addEventListener('DOMContentLoaded', function() {
            startDownload('{{ magnet_link|escapejs }}');
        });
        {% endif %}

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();
            console.log('WebTorrent client initialized');
        });
    </script>
</body>
</html>
